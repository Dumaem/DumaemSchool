@page "/teacher/{id:int}"
@using DumaemSchool.Auth.Models;
@using DumaemSchool.Core.Models;
@using MediatR;
@using Microsoft.AspNetCore.Identity;
@using DumaemSchool.Core.Commands.Teacher
@using DumaemSchool.Core.Queries.Teacher

@inject ISender Sender;
@inject NavigationManager NavigationManager;
@inject UserManager<SchoolUser> UserManager


@if (_currentTeacher is null)
{
    return;
}

<MudContainer Style="margin-left: 0%;margin-top: 2%; width:30%">
    <MudText Typo="Typo.h4">Информация об учителе:</MudText>
    <MudSpacer></MudSpacer>

    <AuthorizeView Roles="@Role.DeputyDirector">
        <Authorized>
            <MudStack>
                <MudTextField Immediate @bind-Value="_currentTeacher.Name"></MudTextField>
                 <MudButton Disabled="@(!TeacherNameChanged)" Variant="@MudBlazor.Variant.Filled"
                            OnClick="@(() => EditTeacher(_currentTeacher))" Color="@Color.Primary">Изменить</MudButton>
             </MudStack>
        </Authorized>
    </AuthorizeView>



    <AuthorizeView Roles="@Role.Teacher">
        <Authorized>
            <MudText Style="margin-top: 2%" Typo="Typo.h5">@_currentTeacher.Name</MudText>
        </Authorized>
    </AuthorizeView>

</MudContainer>

<Sections TeacherId="Id" IsForLesson="false"></Sections>

 @code {

    [Parameter]
    public int Id { get; set; }

    private string? _savedTeacherName;
    private Teacher? _currentTeacher;

    private bool TeacherNameChanged => _currentTeacher?.Name != _savedTeacherName;

    protected override async Task OnInitializedAsync()
    {
        await GetTeacherData();
    }

    private async Task GetTeacherData()
    {
        var result = await Sender.Send(new TeacherInfoQuery(Id));
        if (result is not null)
        {
            _currentTeacher = result;
            _savedTeacherName = _currentTeacher.Name;
        }
    }

    private async Task EditTeacher(Teacher teacher)
    {
        var editTeacherCommand = new EditTeacherNameCommand(teacher);
        var res = await Sender.Send(editTeacherCommand);

        await GetTeacherData();
    }
}
