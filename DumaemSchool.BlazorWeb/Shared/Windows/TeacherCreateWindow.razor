@using DumaemSchool.Auth.Models
@using DumaemSchool.BlazorWeb.Data
@using DumaemSchool.Core.Commands
@using DumaemSchool.Core.Models
@using MediatR

@inject ISender Sender;
@inject ISnackbar Snackbar;

<MudForm @ref="@_form" @onsubmit="@(() => CreateTeacher())">
    <MudDialog>
        <DialogContent>
            <MudTextField Label="Почта" Class="mt-3" Required="true"
                          @bind-Value="_newTeacher.Email" InputType="InputType.Email" Immediate For="@(() => _newTeacher.Email)"/>

            <MudTextField Label="ФИО" Immediate For="@(() => _newTeacher.Name)" InputType="InputType.Text" @bind-Value="_newTeacher.Name"/>
        </DialogContent>
        <DialogActions>
            <MudButton Disabled="@(!IsFormFilled() && _isButtonClicked)" ButtonType="MudBlazor.ButtonType.Submit"
                       Variant="MudBlazor.Variant.Filled" Color="Color.Primary" Class="ml-auto" Style="width: 8vw">
                Создать
            </MudButton>
        </DialogActions>
    </MudDialog>
</MudForm>

@code {

    [CascadingParameter]
    MudDialogInstance? MudDialog { get; set; }

    private MudForm? _form;
    private TeacherCreateCredentials _newTeacher = new();
    private bool _isButtonClicked;

    private async Task CreateTeacher()
    {
        _isButtonClicked = true;
        var teacher = new Teacher
        {Name = _newTeacher.Name};
        var addTeacherCommand = new AddTeacherCommand(teacher, _newTeacher.Email);
        var result = await Sender.Send(addTeacherCommand);
        if (!result.IsSuccess)
        {
            Snackbar.Add("Не удалось добавить преподавателя!", Severity.Error);
            return;
        }
        MudDialog?.Close(DialogResult.Ok(true));
    }

    private bool IsFormFilled()
    {
        return _newTeacher.Email != "" && _newTeacher.Name != "";
    }

}